.link
  %a{href: "#{url_for("/artist/#{model.artist.id}")}"}
    =model.artist.name
.link
  %a{href: "#{url_for("/#{model.class.to_s.downcase}/#{model.id}")}"}
    =model.to_s
.row
  %form.model
    -model.editable_attributes.each do |k,v|
      .input-group.input-group-lg
        %span.input-group-addon
          =k
        %input.form-control{type:"text", name:"#{k}", value: "#{v}", onFocus: "this.dirty=false", onChange: "this.dirty = true", onBlur: "if(this.dirty) {update_model(#{model.id})}"} 
.row
  %img{src: "#{url_for("/images/albums/#{model.image_path}")}"}
.row
  %form.imageform
    .input-group.input-group-lg
      %span.input-group-addon
        Image Url
      %input.form-control{type:"text", name:"image_url"}
    .input-group.input-group-lg
      %span.input-group-addon
        Image Name
      %input.form-control{type:"text", name:"image_name", value: "#{model.image_path}", onFocus: "this.dirty=false", onChange: "this.dirty = true", onBlur: "if(this.dirty) {save_image(#{model.id})}"} 
.row.sp-top-sm.no-pad
  -model.tags.each do |tag|
    %form{class: "tagform#{tag.id}"}
      %input.form-control{type:"text", name:"name", value: "#{tag.name}", onFocus: "this.dirty=false", onChange: "this.dirty = true", onBlur: "if(this.dirty) {update_tag(#{tag.id})}"} 
      %input.btn.btn-warning{type: 'button', onClick:"if(confirm('remove tag?')) { remove_tag(#{model.id}, #{tag.id})}", value: "X"}
  %form.form{id: "newtag"}
    .form-group
      %input.form-control#tag{type: "text", name: "tag", placeholder: "Add Tag"}
      .submit
        %input.btn.btn-default.btn-lg{type:"Submit", value:"Add Tag", onClick: "add_tag(#{model.id})"}
    
.row.sp-top-sm.no-pad
  .col-md-1
    TrackNum
  .col-md-1
    AlbumId
  .col-md-6
    Title
-model.tracks.each do |track|
  %form{class: "trackform#{track.id}"}
    .row.no-pad
      .col-md-1
        %input.col-md-4.form-control{type: 'text', name: 'track_number', value: "#{track.track_number}" , onFocus: "this.dirty=false", onChange: "this.dirty = true", onBlur: "if(this.dirty) {save_track(#{track.id})}"}
      .col-md-1
        %input.col-md-4.form-control{type: 'text', name: 'album_id', value: "#{track.album_id}" , onFocus: "this.dirty=false", onChange: "this.dirty = true", onBlur: "if(this.dirty) {save_track(#{track.id})}"}
      .col-md-6
        %input.form-control{type: 'text', name: 'title', value: "#{track.title}", onFocus: "this.dirty=false;", onChange: "this.dirty = true", onBlur: "if(this.dirty) {save_track(#{track.id})}"}
      .col-md-1
        %input.btn.btn-warning{type: 'button', onClick:"if(confirm('delete track?')) {delete_track(#{track.id})}", value: "delete"}
:javascript
  keypress_enable=false;

  $(document).ready(function() {
    $('#tag').autocomplete({
      serviceUrl: '#{url_for "/searchtags"}',
      paramName: 'q',
      minChars: 1,
      lookupLimit: 50,
      autoSelectFirst: true,
    });
  });

  function remove_tag(album_id, tag_id) {
    var url = "#{url_for('/album/')}" + album_id + '/tag/' + tag_id; 
    $('.tagform' + tag_id).remove();
    return del(url);
  }

  function add_tag(album_id, tag_id) {
    var url = "#{url_for('/album/')}" + album_id + '/tags'; 
    var form= $("#newtag");
    return put(form, url);
  }

  function save_track(id) {
    var form= $(".trackform" + id);
    var url = "#{url_for('/admin/track/')}" + id; 
    return post(form, url);
  }

  function save_image(id) {
    var form= $(".imageform");
    var url = "#{url_for('/admin/album/')}" + id + "/image";
    return post(form, url);
  }

  function update_model(id) {
    var form=$(".model");
    var url = "#{url_for('/admin/album/')}" + id;
    return post(form, url);
  }

  function delete_track(id) {
    var url = "#{url_for('/admin/track/')}" + id;
    $('.trackform' + id).remove();
    return del(url);
  }

  function post(form, url) {
    $.ajax( {
        url: url,
        data: form.serialize(), 
        method: 'post',
    })
    .done(function(msg) {
    });
  }

  function del(url) {
    $.ajax({
      url: url,
      method: 'delete'
    });
  }

  function put(form, url) {
    $.ajax( {
      url: url,
      data: form.serialize(),
      method: 'put',
    })
    .done(function(msg) {
    });
  }
                  
